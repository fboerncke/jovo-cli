#!/usr/bin/node

const { execSync } = require('child_process');
const { Project } = require('@lerna/project');

const project = new Project();
(async () => {
  const packages = await project.getPackages();
  function exec(cmd) {
    return execSync(cmd, { encoding: 'utf-8', stdio: 'pipe' }).replace('\n', '');
  }

  const origin = exec('git config --get remote.origin.url');
  const upstream = exec('git config --get remote.upstream.url');

  for (const pkg of packages) {
    // Push latest tag to origin and upstream, if it exists
    const latestTag = exec(`git describe --abbrev=0 --match "${pkg.name}@*"`);

    exec(`git push ${origin} ${latestTag}`);
    if (upstream) {
      exec(`git push ${upstream} ${latestTag}`);
    }
  }
})()
  .then(() => {
    console.log('✅ Pushed tags to remote');
  })
  .catch((error) => {
    console.error('❌ Error while pushing tags');
    console.error(error);
    process.exit(1);
  });
