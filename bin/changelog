#!/usr/bin/env node

const { join: joinPaths } = require('path');
const { writeFileSync } = require('fs');
const { execSync } = require('child_process');
const { Project } = require('@lerna/project');
const project = new Project();

(async () => {
	const autoChangelog = `npx auto-changelog --stdout --template	./changelog-template.hbs --unreleased --hide-empty-releases --hide-credit	--ignore-commit-pattern ':memo:'`;
  const rootChangelog = execSync(`${autoChangelog} --tag-pattern '.'`);
  writeFileSync('CHANGELOG.md', rootChangelog);
  const packages = await project.getPackages();
  for (const pkg of packages) {
    const stdout = execSync(
      `${autoChangelog} --tag-prefix ${pkg.name}/`,
      { encoding: 'utf-8' }
    );
    writeFileSync(joinPaths(pkg.location, 'CHANGELOG.md'), stdout);
  }
})()
  .then(() => {
    console.log('✅ Generated changelogs successfully');
  })
  .catch((error) => {
    console.error('❌ Error while generating changelogs');
    console.error(error);
    process.exit(1);
  });
